(function () {
  'use strict';

  angular
    .module('calendars')
    .controller('CalendarsListController', CalendarsListController);

  CalendarsListController.$inject = ['CalendarsService'];

  function CalendarsListController(CalendarsService) {
    var vm = this;

	var iCalendarData = [
	'BEGIN:VCALENDAR',
	'METHOD:PUBLISH',
	'PRODID:Microsoft Exchange Server 2010',
	'VERSION:2.0',
	'X-WR-CALNAME:AAW',
	'BEGIN:VTIMEZONE',
	'TZID:(UTC-05:00) Eastern Time (US & Canada)',
	'BEGIN:STANDARD',
	'DTSTART:16010101T020000',
	'TZOFFSETFROM:-0400',
	'TZOFFSETTO:-0500',
	'RRULE:FREQ=YEARLY;INTERVAL=1;BYDAY=1SU;BYMONTH=11',
	'END:STANDARD',
	'BEGIN:DAYLIGHT',
	'DTSTART:16010101T020000',
	'TZOFFSETFROM:-0500',
	'TZOFFSETTO:-0400',
	'RRULE:FREQ=YEARLY;INTERVAL=1;BYDAY=2SU;BYMONTH=3',
	'END:DAYLIGHT',
	'END:VTIMEZONE',
	'BEGIN:VEVENT',
	'DESCRIPTION:\n',
	'UID:040000008200E00074C5B7101A82E008000000003F0C6CFEEC51D3010000000000000000100000003B94AE2A221D114CB3E79BDA0027ACCF',
	'SUMMARY:david',
	'DTSTART;TZID="(UTC-05:00) Eastern Time (US & Canada)":20171017T223000',
	'DTEND;TZID="(UTC-05:00) Eastern Time (US & Canada)":20171017T230000',
	'CLASS:PUBLIC',
	'PRIORITY:5',
	'DTSTAMP:20171102T181554Z',
	'TRANSP:OPAQUE',
	'STATUS:CONFIRMED',
	'SEQUENCE:0',
	'LOCATION:',
	'X-MICROSOFT-CDO-APPT-SEQUENCE:0',
	'X-MICROSOFT-CDO-BUSYSTATUS:BUSY',
	'X-MICROSOFT-CDO-INTENDEDSTATUS:BUSY',
	'X-MICROSOFT-CDO-ALLDAYEVENT:FALSE',
	'X-MICROSOFT-CDO-IMPORTANCE:1',
	'X-MICROSOFT-CDO-INSTTYPE:0',
	'X-MICROSOFT-DISALLOW-COUNTER:FALSE',
	'END:VEVENT',
	'BEGIN:VEVENT',
	'DESCRIPTION:blah blah blah blah\n',
	'UID:040000008200E00074C5B7101A82E008000000008F1FB720B851D301000000000000000010000000150B1DAE0F73A94EBE0DC85C03EA6436',
	'SUMMARY:Test Event',
	'DTSTART;TZID="(UTC-05:00) Eastern Time (US & Canada)":20171030T160000',
	'DTEND;TZID="(UTC-05:00) Eastern Time (US & Canada)":20171030T163000',
	'CLASS:PUBLIC',
	'PRIORITY:5',
	'DTSTAMP:20171102T181554Z',
	'TRANSP:OPAQUE',
	'STATUS:CONFIRMED',
	'SEQUENCE:0',
	'LOCATION:UF',
	'X-MICROSOFT-CDO-APPT-SEQUENCE:0',
	'X-MICROSOFT-CDO-BUSYSTATUS:BUSY',
	'X-MICROSOFT-CDO-INTENDEDSTATUS:BUSY',
	'X-MICROSOFT-CDO-ALLDAYEVENT:FALSE',
	'X-MICROSOFT-CDO-IMPORTANCE:1',
	'X-MICROSOFT-CDO-INSTTYPE:0',
	'X-MICROSOFT-DISALLOW-COUNTER:FALSE',
	'END:VEVENT',
	'BEGIN:VEVENT',
	'DESCRIPTION:meh meh meh meh\n',
	'UID:040000008200E00074C5B7101A82E00800000000A44F8325BA51D301000000000000000010000000423B15FAA286BC4E881054DC6EBA16F2',
	'SUMMARY:Test 2',
	'DTSTART;TZID="(UTC-05:00) Eastern Time (US & Canada)":20171031T110000',
	'DTEND;TZID="(UTC-05:00) Eastern Time (US & Canada)":20171031T113000',
	'CLASS:PUBLIC',
	'PRIORITY:5',
	'DTSTAMP:20171102T181554Z',
	'TRANSP:OPAQUE',
	'STATUS:CONFIRMED',
	'SEQUENCE:0',
	'LOCATION:UF',
	'X-MICROSOFT-CDO-APPT-SEQUENCE:0',
	'X-MICROSOFT-CDO-BUSYSTATUS:BUSY',
	'X-MICROSOFT-CDO-INTENDEDSTATUS:BUSY',
	'X-MICROSOFT-CDO-ALLDAYEVENT:FALSE',
	'X-MICROSOFT-CDO-IMPORTANCE:1',
	'X-MICROSOFT-CDO-INSTTYPE:0',
	'X-MICROSOFT-DISALLOW-COUNTER:FALSE',
	'END:VEVENT',
	'END:VCALENDAR',
	].join("\r\n");


	var jcalData = ICAL.parse(iCalendarData);
	var vcalendar = new ICAL.Component(jcalData);
	var vevents = vcalendar.getAllSubcomponents('vevent');
	var calendars = [];
	vevents.forEach(function(evt, ix, array) {
  		var event = new ICAL.Event(evt);
   		var db = new Date(evt.getFirstPropertyValue('dtstart'));
   		var de = new Date(evt.getFirstPropertyValue('dtend'));
  		var e = {summary: event.summary, description: event.description, begin: db.toLocaleString(), end: de.toLocaleString()};
  		calendars.push(e);
    });
    vm.calendars = calendars
  }
}());
